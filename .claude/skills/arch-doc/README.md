# arch-doc 스킬 사용 설명서

프로젝트의 아키텍처를 자동 분석하고 구조화된 설계 문서를 생성하는 Claude Code 스킬입니다.

## 개요

`arch-doc`은 코드베이스를 탐색하여 아키텍처 설계 문서(`.claude/architecture/*.md`)를 자동으로 생성합니다.

**핵심 기능:**
- `code-explorer` 서브에이전트를 통한 심층 코드 분석
- `sequential-thinking` MCP를 통한 구조적 사고 및 Mermaid 다이어그램 자동 생성
- `context7` MCP를 통한 프레임워크 공식 패턴 조회
- 문서 버전 자동 관리 및 변경이력 추적
- MCP 없이도 동작 (graceful degradation)

## 빠른 시작

```
/arch-doc src/ "Flask REST API, API 레이어와 DB 레이어 중심으로 분석" --author 홍길동
```

실행하면 `.claude/architecture/flask_api_db_layer.md` 파일이 생성됩니다.

## 사용법

```
/arch-doc [경로] [분석 지침] [--author 작성자명]
```

```bash
# 전체 프로젝트 분석 (작성자 지정)
/arch-doc . "Spring Boot, 전체 레이어드 아키텍처 분석" --author 김철수

# 특정 디렉토리 분석
/arch-doc src/ "Flask REST API, API 레이어와 DB 레이어 중심으로 분석" --author 홍길동

# 프론트엔드 컴포넌트 분석
/arch-doc components/ "React 컴포넌트 구조와 상태관리 흐름 분석"

# Django 백엔드 분석
/arch-doc backend/ "Django, ORM과 View 레이어 중심으로 분석" --author John

# 인자 없이 실행 (프롬프트 안내 출력)
/arch-doc
```

> **인자 없이 실행하면** 입력 예시를 안내하는 프롬프트가 출력됩니다.

## 옵션

| 인자 | 필수 | 설명 |
|------|------|------|
| `[경로]` | 필수 | 분석할 디렉토리 또는 파일 경로 (예: `src/`, `.`, `components/`) |
| `[분석 지침]` | 필수 | 분석 관점 및 집중할 레이어를 설명하는 자유 텍스트 |
| `--author [이름]` | 선택 | 문서 작성자 이름. 생략 시 `"Unknown"` |

## 출력 문서 구조

생성된 문서는 `.claude/architecture/{파일명}.md`에 저장됩니다. 파일명은 분석 지침에서 자동 생성됩니다.

```markdown
# MyProject — Flask Architecture

> Author: 홍길동
> Version: v1.0.0
> Last Updated: 2026-02-26
> Generated by /arch-doc | 2026-02-26
> Path analyzed: `src/`
> Guidelines: Flask REST API, API 레이어와 DB 레이어 중심으로 분석
```

| 섹션 | 내용 |
|------|------|
| 1. Overview | 프로젝트 한 줄 요약 + 기술스택 표 |
| 2. 디렉토리 구조 | 핵심 파일 트리 및 역할 설명 |
| 3. 레이어 아키텍처 | Mermaid graph 다이어그램 |
| 4. 앱 실행 흐름 | Mermaid flowchart (초기화 순서) |
| 5. 요청 처리 흐름 | Mermaid sequenceDiagram |
| 6. 인증 흐름 | Mermaid sequenceDiagram (로그인/토큰 검증) |
| 7. 핵심 모듈 | 모듈별 경로와 역할 표 |
| 8~10. 도메인 섹션 | API 구조, 캐싱 전략, 외부 의존성 등 |
| 11. 특이사항 | 알려진 버그, 설계 결정 이유, 주의사항 |
| 📝 변경 이력 | 버전별 변경사항 누적 이력 |

> 섹션은 프로젝트 성격에 따라 자동으로 추가·제거됩니다.

## 버전 관리

기존 파일 없으면 `v1.0.0`으로 시작, 있으면 변경 규모에 따라 자동 증가합니다.

| 변경 규모 | 기준 | 버전 증가 | 예시 |
|-----------|------|-----------|------|
| **patch** | 내용만 갱신, 섹션 구조 변화 없음 | +0.0.1 | v1.0.0 → v1.0.1 |
| **minor** | 섹션 추가·삭제 등 구조 변경 | +0.1.0 | v1.0.0 → v1.1.0 |
| **major** | 전면 재작성 또는 기술스택 변경 | +1.0.0 | v1.0.0 → v2.0.0 |

**주의:** 기존 문서가 있는 경우 `--author`는 무시되고 **기존 작성자가 유지**됩니다. 문서 맨 아래에 변경이력이 자동으로 누적됩니다.

## MCP 서버 설정

MCP 없이도 동작하지만, 설치 시 더 정교한 문서를 생성합니다.

```json
{
  "mcpServers": {
    "sequential-thinking": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-sequential-thinking"]
    },
    "context7": {
      "command": "npx",
      "args": ["-y", "@upstash/context7-mcp"]
    }
  }
}
```

- **sequential-thinking**: 분석 결과 구조화 + Mermaid 다이어그램 생성
- **context7**: Flask, React, Spring 등 공식 아키텍처 패턴 조회

두 MCP 모두 없어도 `code-explorer` 서브에이전트만으로 동작합니다.

## 동작 원리

```
Step 0  인자 파싱 (경로, 지침, --author)
  ↓
Step 1  MCP 가용성 확인 (sequential-thinking, context7)
  ↓
Step 2  Glob + Grep으로 파일 구조 빠르게 수집
  ↓
Step 3  code-explorer 서브에이전트 심층 분석
          └─ 레이어 구조, 모듈 역할, 요청 흐름, 설계 패턴
  ↓
Step 4  sequential-thinking MCP로 분석 결과 구조화 + 다이어그램 변환
  ↓
Step 5  context7 MCP로 프레임워크 공식 패턴 대조
  ↓
Step 5.5  기존 문서 확인 → 버전 결정
  ↓
Step 6  문서 생성 (.claude/architecture/{파일명}.md)
  ↓
Step 7  자체 검증 (\n 오염 검사, 노드 수 확인, 체크리스트)
  ↓
완료 메시지 출력
```

## Mermaid 다이어그램 규칙

| 규칙 | 내용 |
|------|------|
| 줄바꿈 | 노드 레이블 안에서 `\n` 대신 `<br/>` 사용 필수 |
| 노드 수 | 다이어그램당 최대 12개 |
| 엣지 수 | 다이어그램당 최대 15개 |
| subgraph 중첩 | 최대 2단계 |
| 복잡한 흐름 | 여러 다이어그램으로 분리 |

**다이어그램 타입 선택:**

| 상황 | 타입 |
|------|------|
| 요청/응답, 인증 흐름 | `sequenceDiagram` |
| 앱 초기화, 데이터 파이프라인 | `flowchart TD` |
| 레이어 구조, 의존 관계 | `graph TD` / `flowchart LR` |
| 권한 계층, 트리 구조 | `graph LR` |

## FAQ

- **출력 위치**: `.claude/architecture/{파일명}.md` (파일명은 분석 지침 키워드에서 자동 생성)
- **기존 파일**: 덮어쓰지 않고 버전을 올려 변경이력 보존. 이때 `--author`는 무시되고 원저작자 유지
- **MCP 없이**: 동작 가능. 단 정교함 저하될 수 있음
- **지원 언어**: 제한 없음. context7 MCP가 있으면 Flask, React, Spring, Django 등 공식 패턴과 비교도 함
